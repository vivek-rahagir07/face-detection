<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Presence | CognitoAttend</title>
    <meta name="description"
        content="Securely mark your attendance using the CognitoAttend QR scanner. Fast, biometric-linked verification for authorized workspaces.">
    <meta name="keywords" content="QR attendance, mark presence, CognitoAttend QR, biometric scanner">
    <link rel="canonical" href="https://cognitoattend.com/qr.html">

    <!-- Open Graph -->
    <meta property="og:title" content="QR Presence | CognitoAttend">
    <meta property="og:description" content="Scan and mark your attendance instantly.">
    <meta property="og:image" content="folder/cognito attend.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary: #fff;
            --accent: #00f2ff;
            --magenta: #ff00f2;
            --bg: #000;
            --text: #fff;
            --text-muted: #888;
            --success: #00f2ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-bottom: 80px;
            /* Space for bottom strip */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(15, 15, 15, 0.9);
            padding: 30px 20px;
            border-radius: 40px;
            border: 1px solid rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 100px rgba(0, 242, 255, 0.1);
            text-align: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: auto;
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px 16px;
                border-radius: 32px;
            }

            h1 {
                font-size: 1.6rem;
            }

            p {
                font-size: 0.85rem;
                margin-bottom: 20px;
            }
        }

        h1 {
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        p {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            margin-left: 5px;
        }

        input {
            width: 100%;
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            border-radius: 16px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
        }

        button {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:disabled {
            background: #222;
            color: #444;
            cursor: not-allowed;
        }

        button:active {
            transform: scale(0.98);
        }

        #status {
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 20px;
        }

        .success {
            color: var(--success);
        }

        .error {
            color: #ef4444;
        }

        .header-logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .header-logo {
            width: 80px;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            animation: header-logo-pulse 4s ease-in-out infinite;
        }

        @keyframes header-logo-pulse {

            0%,
            100% {
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            }

            50% {
                transform: scale(1.05) translateY(-5px);
                filter: drop-shadow(0 0 25px rgba(255, 0, 242, 0.4));
            }
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        .btn-home {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 100;
        }

        .btn-home:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }


        select {
            width: 100%;
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            border-radius: 16px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            appearance: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <a href="index.html" class="btn-home">üè† Home</a>
    <div class="container" id="app" role="main">
        <div class="header-logo-container">
            <img src="folder/cognito attend.png" alt="CognitoAttend Brand Logo" class="header-logo">
        </div>
        <h1>CognitoAttend</h1>
        <p>Dynamic QR Presence System</p>

        <div id="form-view">
            <div id="dynamic-fields-container">
                <div class="input-group">
                    <label for="name">Your Name</label>
                    <input type="text" id="name" placeholder="Enter your full name" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <button id="btn-submit" aria-label="Mark Presence">‚úÖ Submit Attendance</button>
            </div>
            <div id="status" aria-live="polite">Ready to submit.</div>
        </div>

        <div id="success-view" style="display: none;">
            <div style="font-size: 4rem; color: var(--success); margin-bottom: 20px;">‚úî</div>
            <h2 style="color: var(--success); margin-bottom: 10px;">Presence Marked!</h2>
            <p>Your attendance has been recorded successfully. You can close this window now.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from "./firebase-config.js";


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Authenticated as:", user.uid);
            } else {
                signInAnonymously(auth).catch(e => {
                    console.error("Auth Fail:", e);
                    showStatus("Connection Error: Authentication Failed", "error");
                });
            }
        });

        const params = new URLSearchParams(window.location.search);
        const spaceId = params.get('s');
        const nonce = params.get('n');

        const btnSubmit = document.getElementById('btn-submit');
        const statusDiv = document.getElementById('status');
        const formView = document.getElementById('form-view');
        const successView = document.getElementById('success-view');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        let isReady = false;
        let currentSpaceData = null;

        async function initSystem() {
            try {
                if (!spaceId) {
                    showStatus("Error: Workspace ID missing.", "error");
                    return;
                }

                showStatus("Loading workspace config...", "");
                const spaceSnap = await getDoc(doc(db, 'spaces', spaceId));
                if (!spaceSnap.exists()) {
                    showStatus("Error: Workspace not found.", "error");
                    return;
                }

                currentSpaceData = spaceSnap.data();
                updateFormFields(currentSpaceData.config);

                isReady = true;
                showStatus("Ready to submit.", "success");
            } catch (err) {
                console.error(err);
                showStatus("Initialization error: " + err.message, "error");
            }
        }

        function updateFormFields(config = {}) {
            dynamicFieldsContainer.innerHTML = '';

            // Always Name
            addField('name', 'Your Name', 'text', 'Enter your full name');

            // Configurable fields
            if (config.regNo) addField('regNo', 'Registration Number', 'text', 'Enter registration number');
            if (config.course) addField('course', 'Course / Department', 'text', 'Enter course or department');
            if (config.email) addField('email', 'Email ID', 'email', 'Enter email address');
            if (config.phone) addField('phone', 'Phone Number', 'text', 'Enter phone number');
            if (config.bloodGroup) addField('bloodGroup', 'Blood Group', 'text', 'Enter blood group');
            if (config.weight) addField('weight', 'Weight (kg)', 'text', 'Enter weight');

            // Always Gender for voice customization
            const genderGroup = document.createElement('div');
            genderGroup.className = 'input-group';
            genderGroup.innerHTML = `
                <label for="gender">Gender</label>
                <select id="gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            `;
            dynamicFieldsContainer.appendChild(genderGroup);
        }

        function addField(id, label, type, placeholder) {
            const group = document.createElement('div');
            group.className = 'input-group';
            group.innerHTML = `
                <label for="${id}">${label}</label>
                <input type="${type}" id="${id}" placeholder="${placeholder}" autocomplete="off">
            `;
            dynamicFieldsContainer.appendChild(group);
        }



        function speak(text, gender = 'male', voiceEnabled = false) {
            if (!voiceEnabled) return;

            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(text);

            const performSpeak = () => {
                if (synth.speaking) return;
                const voices = synth.getVoices();

                let selectedVoice = null;
                if (gender === 'female') {
                    selectedVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Google US English') || v.name.includes('Victoria') || v.name.includes('Female'));
                    utterance.pitch = 1.1;
                } else {
                    selectedVoice = voices.find(v => v.name.includes('Alex') || v.name.includes('Google UK English Male') || v.name.includes('Daniel') || v.name.includes('Male'));
                    utterance.pitch = 0.9;
                }

                if (selectedVoice) utterance.voice = selectedVoice;
                synth.speak(utterance);
            };

            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = performSpeak;
            } else {
                performSpeak();
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function markPresence() {
            if (!isReady) return;

            const nameInput = document.getElementById('name');
            const name = nameInput ? nameInput.value.trim() : '';

            if (!name) return showStatus("Please enter your name.", "error");
            if (!spaceId || !nonce) return showStatus("Invalid QR code.", "error");

            btnSubmit.disabled = true;
            showStatus("Submitting attendance<span class=\"loading-dots\"></span>", "");

            try {
                // 1. Verify Space and Nonce
                const spaceRef = doc(db, 'spaces', spaceId);
                const spaceSnap = await getDoc(spaceRef);

                if (!spaceSnap.exists()) throw new Error("Workspace not found.");
                const spaceData = spaceSnap.data();
                if (spaceData.qrNonce !== nonce) throw new Error("QR code expired. Please scan again.");

                // Check Geofencing
                if (spaceData.geofencing && spaceData.geofencing.enabled && spaceData.geofencing.center) {
                    showStatus("Checking location...", "");
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
                    }).catch(err => {
                        throw new Error("Location access required for this workspace.");
                    });

                    const dist = getDistance(
                        pos.coords.latitude, pos.coords.longitude,
                        spaceData.geofencing.center.lat, spaceData.geofencing.center.lng
                    );

                    if (dist > (spaceData.geofencing.radius || 100)) {
                        throw new Error(`Out of range. You are ${(dist / 1000).toFixed(2)}km away.`);
                    }
                }

                // Increment QR Scan Count
                await updateDoc(spaceRef, { qrScanCount: increment(1) });

                // 2. Collect all form data
                const config = spaceData.config || {};
                const gender = document.getElementById('gender').value;
                const regNo = config.regNo ? document.getElementById('regNo').value.trim() : '';
                const course = config.course ? document.getElementById('course').value.trim() : '';
                const email = config.email ? document.getElementById('email').value.trim() : '';
                const phone = config.phone ? document.getElementById('phone').value.trim() : '';
                const bloodGroup = config.bloodGroup ? document.getElementById('bloodGroup').value.trim() : '';
                const weight = config.weight ? document.getElementById('weight').value.trim() : '';

                // 3. Find or Create User Record
                const q = query(collection(db, 'users'), where("spaceId", "==", spaceId), where("name", "==", name));
                const userSnap = await getDocs(q);
                const todayStr = new Date().toDateString();

                if (!userSnap.empty) {
                    const userDoc = userSnap.docs[0];
                    const userData = userDoc.data();

                    if (userData.lastAttendance === todayStr) {
                        showStatus("You've already marked presence today.", "success");
                        finishSubmit(name, gender, spaceData);
                        return;
                    }

                    await updateDoc(doc(db, 'users', userDoc.id), {
                        lastAttendance: todayStr,
                        attendanceCount: increment(1),
                        gender: gender,
                        regNo: regNo || userData.regNo || '',
                        course: course || userData.course || '',
                        email: email || userData.email || '',
                        phone: phone || userData.phone || '',
                        bloodGroup: bloodGroup || userData.bloodGroup || '',
                        weight: weight || userData.weight || ''
                    });

                    await recordAttendanceHistory(userDoc.id, name, regNo || userData.regNo || '', course || userData.course || '', gender);
                } else {
                    const newUserDoc = await addDoc(collection(db, 'users'), {
                        name: name,
                        spaceId: spaceId,
                        lastAttendance: todayStr,
                        attendanceCount: 1,
                        gender: gender,
                        regNo: regNo,
                        course: course,
                        email: email,
                        phone: phone,
                        bloodGroup: bloodGroup,
                        weight: weight,
                        descriptor: null,
                        createdAt: new Date().toISOString(),
                        type: 'qr-manual'
                    });

                    await recordAttendanceHistory(newUserDoc.id, name, regNo, course, gender);
                }

                finishSubmit(name, gender, spaceData);

            } catch (err) {
                showStatus(err.message, "error");
                btnSubmit.disabled = false;
            }
        }

        async function recordAttendanceHistory(userId, name, regNo, course, gender) {
            const dateId = new Date().toISOString().split('T')[0];
            await addDoc(collection(db, 'attendance'), {
                spaceId: spaceId,
                userId: userId,
                name: name,
                regNo: regNo,
                course: course,
                gender: gender,
                date: dateId,
                timestamp: new Date()
            });
            await updateDoc(doc(db, 'spaces', spaceId), {
                [`historyDates.${dateId}`]: true
            });
        }

        function finishSubmit(name, gender, spaceData) {
            if (spaceData.config && spaceData.config.voiceEnabled) {
                speak(`${name} present`, gender, true);
            }
            formView.style.display = 'none';
            successView.style.display = 'block';
        }

        function showStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = type;
        }


        btnSubmit.addEventListener('click', () => markPresence());
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') markPresence();
        });

        initSystem();
    </script>
</body>