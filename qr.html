<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Presence - CognitoAttend</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #fff;
            --accent: #00f2ff;
            --magenta: #ff00f2;
            --bg: #000;
            --text: #fff;
            --text-muted: #888;
            --success: #00f2ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(15, 15, 15, 0.9);
            padding: 40px 30px;
            border-radius: 40px;
            border: 1px solid rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 100px rgba(0, 242, 255, 0.1);
            text-align: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        h1 {
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        p {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            margin-left: 5px;
        }

        input {
            width: 100%;
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            border-radius: 16px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
        }

        button {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:disabled {
            background: #222;
            color: #444;
            cursor: not-allowed;
        }

        button:active {
            transform: scale(0.98);
        }

        #status {
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 20px;
        }

        .success {
            color: var(--success);
        }

        .error {
            color: #ef4444;
        }

        .header-logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .header-logo {
            width: 80px;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            animation: header-logo-pulse 4s ease-in-out infinite;
        }

        @keyframes header-logo-pulse {

            0%,
            100% {
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            }

            50% {
                transform: scale(1.05) translateY(-5px);
                filter: drop-shadow(0 0 25px rgba(255, 0, 242, 0.4));
            }
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        /* Branding Strip Styles */
        .bottom-strip {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .shining-logo {
            width: 50px;
            height: auto;
            animation: logo-blink 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.5));
        }

        .nav-brand {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .nav-logo-container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -150%;
            width: 50%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(30deg);
            animation: light-sweep 4s infinite;
            pointer-events: none;
        }

        @keyframes logo-blink {

            0%,
            100% {
                opacity: 1;
                filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.8));
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                filter: drop-shadow(0 0 5px rgba(0, 242, 255, 0.3));
                transform: scale(0.98);
            }
        }

        @keyframes light-sweep {
            0% {
                left: -150%;
            }

            50%,
            100% {
                left: 250%;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="app">
        <div class="header-logo-container">
            <img src="folder/cognito attend.png" alt="CognitoAttend Logo" class="header-logo">
        </div>
        <h1>CognitoAttend</h1>
        <p>Dynamic QR Presence System</p>

        <div id="form-view">
            <div class="input-group">
                <label for="name">Your Name</label>
                <input type="text" id="name" placeholder="Enter your full name" autocomplete="off">
            </div>
            <div class="input-group">
                <label for="gender">Gender</label>
                <select id="gender"
                    style="width: 100%; background: #111; border: 1px solid rgba(255, 255, 255, 0.1); padding: 16px 20px; border-radius: 16px; color: #fff; font-size: 1rem; outline: none; transition: all 0.3s; appearance: none; cursor: pointer;">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <button id="btn-submit">Mark Presence</button>
            <div id="status"></div>
        </div>

        <div id="success-view" style="display: none;">
            <div style="font-size: 4rem; color: var(--success); margin-bottom: 20px;">✔</div>
            <h2 style="color: var(--success); margin-bottom: 10px;">Presence Marked!</h2>
            <p>Your attendance has been recorded successfully. You can close this window now.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Must match main.js)
        const firebaseConfig = {
            apiKey: "AIzaSyAf9xAmQtFZcvE8tvxpI-tU5teS89Dc6II",
            authDomain: "live-face-attendence-detection.firebaseapp.com",
            projectId: "live-face-attendence-detection",
            storageBucket: "live-face-attendence-detection.firebasestorage.app",
            messagingSenderId: "67072118378",
            appId: "1:67072118378:web:a988976e9233434b3fc413"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Ensure anonymous auth for connectivity
        let currentUser = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Authenticated as:", user.uid);
            } else {
                signInAnonymously(auth).catch(e => {
                    console.error("Auth Fail:", e);
                    showStatus("Connection Error: Authentication Failed", "error");
                });
            }
        });

        const params = new URLSearchParams(window.location.search);
        const spaceId = params.get('s');
        const nonce = params.get('n');

        const btnSubmit = document.getElementById('btn-submit');
        const inputName = document.getElementById('name');
        const statusDiv = document.getElementById('status');
        const formView = document.getElementById('form-view');
        const successView = document.getElementById('success-view');
        const inputGender = document.getElementById('gender');

        function speak(text, gender = 'male', voiceEnabled = false) {
            if (!voiceEnabled) return;

            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(text);

            const performSpeak = () => {
                if (synth.speaking) return;
                const voices = synth.getVoices();

                let selectedVoice = null;
                if (gender === 'female') {
                    selectedVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Google US English') || v.name.includes('Victoria') || v.name.includes('Female'));
                    utterance.pitch = 1.1;
                } else {
                    selectedVoice = voices.find(v => v.name.includes('Alex') || v.name.includes('Google UK English Male') || v.name.includes('Daniel') || v.name.includes('Male'));
                    utterance.pitch = 0.9;
                }

                if (selectedVoice) utterance.voice = selectedVoice;
                synth.speak(utterance);
            };

            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = performSpeak;
            } else {
                performSpeak();
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function markPresence() {
            const name = inputName.value.trim();
            if (!name) return showStatus("Please enter your name.", "error");
            if (!spaceId || !nonce) return showStatus("Invalid QR code.", "error");

            btnSubmit.disabled = true;
            showStatus("Verifying code<span class=\"loading-dots\"></span>", "");

            try {
                // 1. Verify Space and Nonce
                const spaceRef = doc(db, 'spaces', spaceId);
                const spaceSnap = await getDoc(spaceRef);

                if (!spaceSnap.exists()) throw new Error("Workspace not found.");
                const spaceData = spaceSnap.data();
                if (spaceData.qrNonce !== nonce) throw new Error("QR code expired. Please scan again.");

                // Geofencing Check
                if (spaceData.geofencing && spaceData.geofencing.enabled && spaceData.geofencing.center) {
                    showStatus("Checking location...", "");
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
                    }).catch(err => {
                        throw new Error("Location access required for this workspace.");
                    });

                    const dist = getDistance(
                        pos.coords.latitude, pos.coords.longitude,
                        spaceData.geofencing.center.lat, spaceData.geofencing.center.lng
                    );

                    if (dist > (spaceData.geofencing.radius || 100)) {
                        throw new Error(`Out of range. You are ${(dist / 1000).toFixed(2)}km away.`);
                    }
                }

                // 2. Find or Create User Record
                const gender = inputGender.value;
                const q = query(collection(db, 'users'), where("spaceId", "==", spaceId), where("name", "==", name));
                const userSnap = await getDocs(q);
                const todayStr = new Date().toDateString();

                if (!userSnap.empty) {
                    const userDoc = userSnap.docs[0];
                    const userData = userDoc.data();

                    if (userData.lastAttendance === todayStr) {
                        return showStatus("You've already marked presence today.", "success");
                    }

                    await updateDoc(doc(db, 'users', userDoc.id), {
                        lastAttendance: todayStr,
                        attendanceCount: increment(1),
                        gender: gender // Update gender in case it was changed
                    });

                    // Save to History
                    const dateId = new Date().toISOString().split('T')[0];
                    await addDoc(collection(db, 'attendance'), {
                        spaceId: spaceId,
                        userId: userDoc.id,
                        name: name,
                        regNo: userData.regNo || '',
                        course: userData.course || '',
                        gender: gender,
                        date: dateId,
                        timestamp: new Date()
                    });
                    await updateDoc(doc(db, 'spaces', spaceId), {
                        [`historyDates.${dateId}`]: true
                    });
                } else {
                    // Create minimal entry for QR attendance
                    const newUserDoc = await addDoc(collection(db, 'users'), {
                        name: name,
                        spaceId: spaceId,
                        lastAttendance: todayStr,
                        attendanceCount: 1,
                        gender: gender,
                        createdAt: new Date().toISOString(),
                        type: 'qr-lite'
                    });

                    // Save to History
                    const dateId = new Date().toISOString().split('T')[0];
                    await addDoc(collection(db, 'attendance'), {
                        spaceId: spaceId,
                        userId: newUserDoc.id,
                        name: name,
                        gender: gender,
                        date: dateId,
                        timestamp: new Date()
                    });
                    await updateDoc(doc(db, 'spaces', spaceId), {
                        [`historyDates.${dateId}`]: true
                    });
                }

                if (spaceData.config && spaceData.config.voiceEnabled) {
                    speak(`Welcome ${name}`, gender, true);
                }

                formView.style.display = 'none';
                successView.style.display = 'block';

            } catch (err) {
                showStatus(err.message, "error");
                btnSubmit.disabled = false;
            }
        }

        function showStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = type;
        }

        btnSubmit.addEventListener('click', markPresence);
        inputName.addEventListener('keypress', (e) => { if (e.key === 'Enter') markPresence(); });
    </script>
    <div class="bottom-strip">
        <div class="nav-logo-container">
            <img src="folder/cognito attend.png" alt="CognitoAttend Logo" class="shining-logo">
            <span class="nav-brand">CognitoAttend</span>
        </div>
    </div>
</body>

</html>