<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Presence | CognitoAttend</title>
    <meta name="description"
        content="Securely mark your attendance using the CognitoAttend QR scanner. Fast, biometric-linked verification for authorized workspaces.">
    <meta name="keywords" content="QR attendance, mark presence, CognitoAttend QR, biometric scanner">
    <link rel="canonical" href="https://cognitoattend.com/qr.html">

    <!-- Open Graph -->
    <meta property="og:title" content="QR Presence | CognitoAttend">
    <meta property="og:description" content="Scan and mark your attendance instantly.">
    <meta property="og:image" content="folder/cognito attend.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary: #fff;
            --accent: #00f2ff;
            --magenta: #ff00f2;
            --bg: #000;
            --text: #fff;
            --text-muted: #888;
            --success: #00f2ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-bottom: 80px;
            /* Space for bottom strip */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(15, 15, 15, 0.9);
            padding: 30px 20px;
            border-radius: 40px;
            border: 1px solid rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 100px rgba(0, 242, 255, 0.1);
            text-align: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: auto;
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px 16px;
                border-radius: 32px;
            }

            h1 {
                font-size: 1.6rem;
            }

            p {
                font-size: 0.85rem;
                margin-bottom: 20px;
            }
        }

        h1 {
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        p {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            margin-left: 5px;
        }

        input {
            width: 100%;
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            border-radius: 16px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
        }

        button {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:disabled {
            background: #222;
            color: #444;
            cursor: not-allowed;
        }

        button:active {
            transform: scale(0.98);
        }

        #status {
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 20px;
        }

        .success {
            color: var(--success);
        }

        .error {
            color: #ef4444;
        }

        .header-logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .header-logo {
            width: 80px;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            animation: header-logo-pulse 4s ease-in-out infinite;
        }

        @keyframes header-logo-pulse {

            0%,
            100% {
                transform: scale(1) translateY(0);
                filter: drop-shadow(0 0 15px rgba(0, 242, 255, 0.6));
            }

            50% {
                transform: scale(1.05) translateY(-5px);
                filter: drop-shadow(0 0 25px rgba(255, 0, 242, 0.4));
            }
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        .btn-home {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 100;
        }

        .btn-home:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>

<body>
    <a href="index.html" class="btn-home">üè† Home</a>
    <div class="container" id="app">
        <div class="header-logo-container">
            <img src="folder/cognito attend.png" alt="CognitoAttend Logo" class="header-logo">
        </div>
        <h1>CognitoAttend</h1>
        <p>Dynamic QR Presence System</p>

        <div id="form-view">
            <div class="camera-box"
                style="width: 100%; aspect-ratio: 4/3; background: #111; border-radius: 20px; overflow: hidden; border: 1px solid rgba(0, 242, 255, 0.2); margin-bottom: 20px; position: relative;">
                <video id="video" autoplay muted playsinline
                    style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="overlay"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                <div id="loading-overlay"
                    style="position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 10;">
                    <div
                        style="width: 30px; height: 30px; border: 2px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;">
                    </div>
                    <p style="margin-top: 10px; font-size: 0.7rem; color: var(--accent);">Initializing AI...</p>
                </div>
            </div>

            <div class="input-group">
                <label for="name">Your Name</label>
                <input type="text" id="name" placeholder="Enter your full name" autocomplete="off">
            </div>
            <div class="input-group">
                <label for="gender">Gender</label>
                <select id="gender"
                    style="width: 100%; background: #111; border: 1px solid rgba(255, 255, 255, 0.1); padding: 16px 20px; border-radius: 16px; color: #fff; font-size: 1rem; outline: none; transition: all 0.3s; appearance: none; cursor: pointer;">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <button id="btn-submit">üì∏ Mark Presence</button>
                <button id="btn-gallery"
                    style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #fff;">üñºÔ∏è From
                    Gallery</button>
                <input type="file" id="input-gallery" accept="image/*" style="display: none;">
            </div>
            <div id="status">Ready to scan.</div>
        </div>

        <div id="success-view" style="display: none;">
            <div style="font-size: 4rem; color: var(--success); margin-bottom: 20px;">‚úî</div>
            <h2 style="color: var(--success); margin-bottom: 10px;">Presence Marked!</h2>
            <p>Your attendance has been recorded successfully. You can close this window now.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Must match main.js)
        const firebaseConfig = {
            apiKey: "AIzaSyAf9xAmQtFZcvE8tvxpI-tU5teS89Dc6II",
            authDomain: "live-face-attendence-detection.firebaseapp.com",
            projectId: "live-face-attendence-detection",
            storageBucket: "live-face-attendence-detection.firebasestorage.app",
            messagingSenderId: "67072118378",
            appId: "1:67072118378:web:a988976e9233434b3fc413"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Ensure anonymous auth for connectivity
        let currentUser = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Authenticated as:", user.uid);
            } else {
                signInAnonymously(auth).catch(e => {
                    console.error("Auth Fail:", e);
                    showStatus("Connection Error: Authentication Failed", "error");
                });
            }
        });

        const params = new URLSearchParams(window.location.search);
        const spaceId = params.get('s');
        const nonce = params.get('n');

        const btnSubmit = document.getElementById('btn-submit');
        const inputName = document.getElementById('name');
        const statusDiv = document.getElementById('status');
        const formView = document.getElementById('form-view');
        const successView = document.getElementById('success-view');
        const inputGender = document.getElementById('gender');
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const btnGallery = document.getElementById('btn-gallery');
        const inputGallery = document.getElementById('input-gallery');

        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let faceMatcher = null;
        let lastDetections = [];
        let isReady = false;

        async function initSystem() {
            try {
                // Load Models
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                // Start Video
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    loadingOverlay.style.display = 'none';
                    isReady = true;
                    requestAnimationFrame(processFrame);
                };

                // Load Labeled Descriptors from Space
                if (spaceId) {
                    const q = query(collection(db, 'users'), where("spaceId", "==", spaceId));
                    const snap = await getDocs(q);
                    const labeled = [];
                    snap.forEach(doc => {
                        const data = doc.data();
                        if (data.descriptor && data.name) {
                            labeled.push(new faceapi.LabeledFaceDescriptors(data.name, [new Float32Array(data.descriptor)]));
                        }
                    });
                    if (labeled.length > 0) {
                        faceMatcher = new faceapi.FaceMatcher(labeled, 0.4);
                    }
                }

            } catch (err) {
                console.error(err);
                showStatus("Hardware error: " + err.message, "error");
            }
        }

        async function processFrame() {
            if (!isReady) return;
            const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
            lastDetections = detections;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections && detections.length > 0) {
                detections.forEach(detection => {
                    const box = detection.detection.box;
                    drawHUD(ctx, box, "");
                });
            }

            requestAnimationFrame(processFrame);
        }

        function drawHUD(ctx, box, name) {
            const color = '#00f2ff';
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            const size = 30;
            const pad = 10;
            const { x, y, width: w, height: h } = box;

            const drawC = (cx, cy, dx, dy) => {
                ctx.beginPath();
                ctx.moveTo(cx, cy + dy * size); ctx.lineTo(cx, cy); ctx.lineTo(cx + dx * size, cy);
                ctx.stroke();
            };
            drawC(x - pad, y - pad, 1, 1); drawC(x + w + pad, y - pad, -1, 1);
            drawC(x - pad, y + h + pad, 1, -1); drawC(x + w + pad, y + h + pad, -1, -1);
        }

        function speak(text, gender = 'male', voiceEnabled = false) {
            if (!voiceEnabled) return;

            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(text);

            const performSpeak = () => {
                if (synth.speaking) return;
                const voices = synth.getVoices();

                let selectedVoice = null;
                if (gender === 'female') {
                    selectedVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Google US English') || v.name.includes('Victoria') || v.name.includes('Female'));
                    utterance.pitch = 1.1;
                } else {
                    selectedVoice = voices.find(v => v.name.includes('Alex') || v.name.includes('Google UK English Male') || v.name.includes('Daniel') || v.name.includes('Male'));
                    utterance.pitch = 0.9;
                }

                if (selectedVoice) utterance.voice = selectedVoice;
                synth.speak(utterance);
            };

            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = performSpeak;
            } else {
                performSpeak();
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function markPresence(descriptor = null) {
            const name = inputName.value.trim();
            if (!name) return showStatus("Please enter your name.", "error");
            if (!spaceId || !nonce) return showStatus("Invalid QR code.", "error");

            // Biometric Check
            let finalDescriptor = descriptor;
            if (!finalDescriptor) {
                if (lastDetections && lastDetections.length > 0) {
                    // Find the best match among all detected faces for the entered name
                    if (faceMatcher) {
                        const matches = lastDetections.map(d => ({
                            descriptor: d.descriptor,
                            match: faceMatcher.findBestMatch(d.descriptor)
                        }));
                        const userMatch = matches.find(m => m.match.label === name);
                        if (userMatch) {
                            finalDescriptor = userMatch.descriptor;
                        } else {
                            // If no exact name match, take the first face detected
                            finalDescriptor = lastDetections[0].descriptor;
                        }
                    } else {
                        finalDescriptor = lastDetections[0].descriptor;
                    }
                }
            }

            if (!finalDescriptor) return showStatus("No face detected. Align your face with the camera.", "error");

            btnSubmit.disabled = true;
            showStatus("Verifying identity<span class=\"loading-dots\"></span>", "");

            try {
                // 1. Verify Space and Nonce
                const spaceRef = doc(db, 'spaces', spaceId);
                const spaceSnap = await getDoc(spaceRef);

                if (!spaceSnap.exists()) throw new Error("Workspace not found.");
                const spaceData = spaceSnap.data();
                if (spaceData.qrNonce !== nonce) throw new Error("QR code expired. Please scan again.");

                // Match Face
                if (faceMatcher) {
                    const match = faceMatcher.findBestMatch(finalDescriptor);
                    if (match.label !== 'unknown' && match.label !== name) {
                        // If they entered a name but the face matches someone else
                        throw new Error(`Face mismatch. Detected: ${match.label}`);
                    }
                    if (match.label === 'unknown' && faceMatcher.labeledDescriptors.length > 0) {
                        // Optional: allow new person or strictly require registration
                        // console.log("New face detected for existing user name?");
                    }
                }

                // Geofencing Check
                if (spaceData.geofencing && spaceData.geofencing.enabled && spaceData.geofencing.center) {
                    showStatus("Checking location...", "");
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
                    }).catch(err => {
                        throw new Error("Location access required for this workspace.");
                    });

                    const dist = getDistance(
                        pos.coords.latitude, pos.coords.longitude,
                        spaceData.geofencing.center.lat, spaceData.geofencing.center.lng
                    );

                    if (dist > (spaceData.geofencing.radius || 100)) {
                        throw new Error(`Out of range. You are ${(dist / 1000).toFixed(2)}km away.`);
                    }
                }

                // 2. Find or Create User Record
                const gender = inputGender.value;
                const q = query(collection(db, 'users'), where("spaceId", "==", spaceId), where("name", "==", name));
                const userSnap = await getDocs(q);
                const todayStr = new Date().toDateString();

                if (!userSnap.empty) {
                    const userDoc = userSnap.docs[0];
                    const userData = userDoc.data();

                    if (userData.lastAttendance === todayStr) {
                        showStatus("You've already marked presence today.", "success");
                        finishSubmit(name, gender, spaceData);
                        return;
                    }

                    await updateDoc(doc(db, 'users', userDoc.id), {
                        lastAttendance: todayStr,
                        attendanceCount: increment(1),
                        gender: gender
                    });

                    await recordAttendanceHistory(userDoc.id, name, userData.regNo || '', userData.course || '', gender);
                } else {
                    const newUserDoc = await addDoc(collection(db, 'users'), {
                        name: name,
                        spaceId: spaceId,
                        lastAttendance: todayStr,
                        attendanceCount: 1,
                        gender: gender,
                        descriptor: Array.from(finalDescriptor),
                        createdAt: new Date().toISOString(),
                        type: 'qr-biometric'
                    });

                    await recordAttendanceHistory(newUserDoc.id, name, '', '', gender);
                }

                finishSubmit(name, gender, spaceData);

            } catch (err) {
                showStatus(err.message, "error");
                btnSubmit.disabled = false;
            }
        }

        async function recordAttendanceHistory(userId, name, regNo, course, gender) {
            const dateId = new Date().toISOString().split('T')[0];
            await addDoc(collection(db, 'attendance'), {
                spaceId: spaceId,
                userId: userId,
                name: name,
                regNo: regNo,
                course: course,
                gender: gender,
                date: dateId,
                timestamp: new Date()
            });
            await updateDoc(doc(db, 'spaces', spaceId), {
                [`historyDates.${dateId}`]: true
            });
        }

        function finishSubmit(name, gender, spaceData) {
            if (spaceData.config && spaceData.config.voiceEnabled) {
                speak(`Welcome ${name}`, gender, true);
            }
            formView.style.display = 'none';
            successView.style.display = 'block';
        }

        function showStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = type;
        }

        btnGallery.onclick = () => inputGallery.click();
        inputGallery.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const name = inputName.value.trim();
            if (!name) {
                alert("Please enter your name first.");
                e.target.value = '';
                return;
            }
            showStatus("Processing Photo...", "");
            try {
                const img = await faceapi.bufferToImage(file);
                const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                if (detection) {
                    await markPresence(detection.descriptor);
                } else {
                    alert("No face detected in photo.");
                    showStatus("No face detected in upload", "error");
                }
            } catch (err) {
                alert("Error processing image.");
            }
            e.target.value = '';
        };

        btnSubmit.addEventListener('click', () => markPresence());
        inputName.addEventListener('keypress', (e) => { if (e.key === 'Enter') markPresence(); });

        initSystem();
    </script>
</body>

</html>